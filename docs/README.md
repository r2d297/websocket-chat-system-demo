# WebSocket Gateway å®ç°è¯¦è§£æ–‡æ¡£

> å®Œæ•´çš„åˆ†å¸ƒå¼ WebSocket æ¶æ„å®ç°è§£æ

## ğŸ“š æ–‡æ¡£ç›®å½•

### æ ¸å¿ƒç»„ä»¶è¯¦è§£

1. **[Router å®ç°è¯¦è§£](./01-routerå®ç°è¯¦è§£.md)** â­ï¸
   - è·¨ç½‘å…³æ¶ˆæ¯è·¯ç”±æ ¸å¿ƒ
   - Redis Pub/Sub æœºåˆ¶
   - æ¶ˆæ¯åºåˆ—åŒ–ä¸ååºåˆ—åŒ–
   - å¹¶å‘å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–

2. **[Handler å®ç°è¯¦è§£](./02-handlerå®ç°è¯¦è§£.md)** â­ï¸
   - WebSocket è¿æ¥å¤„ç†
   - æ¶ˆæ¯ç±»å‹è·¯ç”±
   - å¿ƒè·³æœºåˆ¶å®ç°
   - ç”¨æˆ·æ³¨å†Œä¸è®¤è¯æµç¨‹

3. **[Presence å®ç°è¯¦è§£](./03-presenceå®ç°è¯¦è§£.md)** â­ï¸â­ï¸
   - Redis çŠ¶æ€ç®¡ç†
   - CAS æœºåˆ¶é˜²æ­¢ç«æ€
   - TTL è‡ªåŠ¨æ¸…ç†
   - Lua è„šæœ¬åŸå­æ“ä½œ

4. **[Connection å®ç°è¯¦è§£](./04-connectionå®ç°è¯¦è§£.md)** â­ï¸
   - è¿æ¥å¯¹è±¡å°è£…
   - åŒå‘ç´¢å¼•è®¾è®¡
   - sync.Map æ€§èƒ½ä¼˜åŒ–
   - å¹¶å‘å®‰å…¨ä¿è¯

5. **[Server å®ç°è¯¦è§£](./05-serverå®ç°è¯¦è§£.md)** â­ï¸
   - HTTP æœåŠ¡å™¨é…ç½®
   - ç»„ä»¶åè°ƒä¸å¯åŠ¨
   - ä¼˜é›…å…³é—­æœºåˆ¶
   - å¥åº·æ£€æŸ¥ä¸ç›‘æ§

### æµ‹è¯•ä¸éªŒè¯

6. **[æ•…éšœæ¢å¤æµ‹è¯•ç»“æœ](../FAILOVER_TEST_RESULTS.md)**
   - Gateway æ•…éšœæ¨¡æ‹Ÿ
   - å®¢æˆ·ç«¯é‡è¿éªŒè¯
   - æ¶ˆæ¯è·¯ç”±æ¢å¤
   - æ¶æ„éŸ§æ€§åˆ†æ

---

## ğŸ¯ å¿«é€Ÿå¯¼èˆª

### æŒ‰å…³æ³¨ç‚¹é˜…è¯»

#### ğŸ”¥ æ¶ˆæ¯è·¯ç”±æœºåˆ¶
- [Router å®ç°è¯¦è§£](./01-routerå®ç°è¯¦è§£.md) - Redis Pub/Sub æ ¸å¿ƒ
- [Handler æ¶ˆæ¯è·¯ç”±éƒ¨åˆ†](./02-handlerå®ç°è¯¦è§£.md#æ¶ˆæ¯è·¯ç”±è¯¦è§£) - æœ¬åœ°è·¯ç”±é€»è¾‘
- [Presence æŸ¥è¯¢](./03-presenceå®ç°è¯¦è§£.md#get---æŸ¥è¯¢ç”¨æˆ·ä½ç½®) - ç”¨æˆ·ä½ç½®æŸ¥æ‰¾

#### ğŸ” çŠ¶æ€ç®¡ç†
- [Presence å®ç°è¯¦è§£](./03-presenceå®ç°è¯¦è§£.md) - å…¨å±€çŠ¶æ€æ ¸å¿ƒ
- [Connection ç®¡ç†å™¨](./04-connectionå®ç°è¯¦è§£.md#connectionmanager-è¯¦è§£) - æœ¬åœ°çŠ¶æ€
- [åŒå‘æ˜ å°„è®¾è®¡](./04-connectionå®ç°è¯¦è§£.md#æ ¸å¿ƒè®¾è®¡åŒå‘æ˜ å°„) - é«˜æ•ˆç´¢å¼•

#### âš¡ æ€§èƒ½ä¼˜åŒ–
- [sync.Map ä½¿ç”¨](./04-connectionå®ç°è¯¦è§£.md#ä¸ºä»€ä¹ˆç”¨-syncmap) - å¹¶å‘ä¼˜åŒ–
- [Pipeline æ‰¹é‡æ“ä½œ](./03-presenceå®ç°è¯¦è§£.md#refresh---åˆ·æ–°å¿ƒè·³) - Redis ä¼˜åŒ–
- [Lua è„šæœ¬](./03-presenceå®ç°è¯¦è§£.md#lua-è„šæœ¬è¯¦è§£) - åŸå­æ“ä½œ

#### ğŸ›¡ï¸ å¯é æ€§ä¿è¯
- [CAS æœºåˆ¶](./03-presenceå®ç°è¯¦è§£.md#register-çš„-cas-ç«æ€è¯¦è§£) - é˜²æ­¢ç«æ€
- [å¿ƒè·³ä¸ TTL](./02-handlerå®ç°è¯¦è§£.md#å¿ƒè·³æœºåˆ¶è¯¦è§£) - è¿æ¥ä¿æ´»
- [ä¼˜é›…å…³é—­](./05-serverå®ç°è¯¦è§£.md#stop-æ–¹æ³•---ä¼˜é›…å…³é—­) - èµ„æºæ¸…ç†

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Client Layer                       â”‚
â”‚                   (WebSocket å®¢æˆ·ç«¯)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Gateway Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  server.go - HTTP/WebSocket æœåŠ¡å™¨               â”‚  â”‚
â”‚  â”‚  â€¢ handleWebSocket (WebSocket å‡çº§)              â”‚  â”‚
â”‚  â”‚  â€¢ handleHealth (å¥åº·æ£€æŸ¥)                       â”‚  â”‚
â”‚  â”‚  â€¢ handleStats (ç›‘æ§ç»Ÿè®¡)                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  handler.go - ä¸šåŠ¡é€»è¾‘å±‚                          â”‚  â”‚
â”‚  â”‚  â€¢ handleConnection (è¿æ¥å¤„ç†)                    â”‚  â”‚
â”‚  â”‚  â€¢ routeMessage (æ¶ˆæ¯è·¯ç”±)                        â”‚  â”‚
â”‚  â”‚  â€¢ deliverMessage (æœ¬åœ°æŠ•é€’)                      â”‚  â”‚
â”‚  â”‚  â€¢ heartbeatChecker (å¿ƒè·³æ£€æµ‹)                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â”‚                   â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ connection.go   â”‚  â”‚   router.go      â”‚             â”‚
â”‚  â”‚ æœ¬åœ°è¿æ¥ç®¡ç†     â”‚  â”‚   è·¨ç½‘å…³è·¯ç”±      â”‚             â”‚
â”‚  â”‚                 â”‚  â”‚                  â”‚             â”‚
â”‚  â”‚ â€¢ Connection    â”‚  â”‚ â€¢ RouteToGateway â”‚             â”‚
â”‚  â”‚ â€¢ ConnManager   â”‚  â”‚ â€¢ processMessagesâ”‚             â”‚
â”‚  â”‚ â€¢ åŒå‘ç´¢å¼•       â”‚  â”‚ â€¢ Redis Pub/Sub  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      presence.go               â”‚  â”‚    Redis Pub/Sub    â”‚
â”‚      å…¨å±€çŠ¶æ€ç®¡ç†               â”‚  â”‚    æ¶ˆæ¯è·¯ç”±æ€»çº¿      â”‚
â”‚                                â”‚  â”‚                     â”‚
â”‚  â€¢ Register (CAS æ³¨å†Œ)         â”‚  â”‚  gateway:gw-01      â”‚
â”‚  â€¢ Refresh (TTL åˆ·æ–°)          â”‚  â”‚  gateway:gw-02      â”‚
â”‚  â€¢ Get (ä½ç½®æŸ¥è¯¢)              â”‚  â”‚  gateway:gw-03      â”‚
â”‚  â€¢ Remove (çŠ¶æ€æ¸…ç†)           â”‚  â”‚  gateway:broadcast  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    Redis Cluster      â”‚
        â”‚    (çŠ¶æ€å­˜å‚¨)          â”‚
        â”‚                       â”‚
        â”‚  presence:alice       â”‚
        â”‚  presence:bob         â”‚
        â”‚  presence:charlie     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ç»„ä»¶èŒè´£çŸ©é˜µ

| ç»„ä»¶ | ä¸»è¦èŒè´£ | ä¾èµ– | è¢«ä¾èµ– |
|------|---------|------|--------|
| **server.go** | HTTP æœåŠ¡ã€ç»„ä»¶åè°ƒ | æ‰€æœ‰ç»„ä»¶ | main.go |
| **handler.go** | è¿æ¥å¤„ç†ã€ä¸šåŠ¡é€»è¾‘ | connection, presence, router | server.go |
| **router.go** | è·¨ç½‘å…³æ¶ˆæ¯è·¯ç”± | Redis | handler.go |
| **presence.go** | å…¨å±€çŠ¶æ€ç®¡ç† | Redis | handler.go |
| **connection.go** | æœ¬åœ°è¿æ¥ç®¡ç† | - | handler.go |

---

## ğŸ” å…³é”®è®¾è®¡æ¨¡å¼

### 1. ä¾èµ–æ³¨å…¥ (Dependency Injection)
- **ä½ç½®**: `server.go:NewServer()`
- **ç¤ºä¾‹**: Redis å®¢æˆ·ç«¯ä»å¤–éƒ¨æ³¨å…¥
- **å¥½å¤„**: å¯æµ‹è¯•æ€§ã€é…ç½®çµæ´»æ€§

### 2. å›è°ƒæ¨¡å¼ (Callback Pattern)
- **ä½ç½®**: `router.go:Start(handler)`
- **ç¤ºä¾‹**: Router é€šè¿‡å›è°ƒé€šçŸ¥ Handler æŠ•é€’æ¶ˆæ¯
- **å¥½å¤„**: è§£è€¦ã€ä¾èµ–å€’ç½®

### 3. åŒå‘ç´¢å¼• (Bidirectional Index)
- **ä½ç½®**: `connection.go:ConnectionManager`
- **ç¤ºä¾‹**: `userToConn` + `connToUser`
- **å¥½å¤„**: O(1) æŸ¥è¯¢ï¼Œå†…å­˜æ¢æ—¶é—´

### 4. CAS æ›´æ–° (Compare-And-Set)
- **ä½ç½®**: `presence.go:Register()`
- **ç¤ºä¾‹**: Lua è„šæœ¬æ—¶é—´æˆ³æ¯”è¾ƒ
- **å¥½å¤„**: é˜²æ­¢ç«æ€æ¡ä»¶

### 5. ä¼˜é›…å…³é—­ (Graceful Shutdown)
- **ä½ç½®**: `server.go:Stop()`
- **ç¤ºä¾‹**: Context å–æ¶ˆ + è¿æ¥æ’ç©º
- **å¥½å¤„**: é›¶æ¶ˆæ¯ä¸¢å¤±

---

## ğŸ’¡ æœ€ä½³å®è·µæ€»ç»“

### å¹¶å‘å®‰å…¨
- âœ… ä½¿ç”¨ `sync.Map` å¤„ç†è¯»å¤šå†™å°‘åœºæ™¯
- âœ… ç»†ç²’åº¦é”ï¼ˆæ¯ä¸ª Connection ç‹¬ç«‹é”ï¼‰
- âœ… é¿å…åœ¨éå†ä¸­ä¿®æ”¹ mapï¼ˆä¸¤é˜¶æ®µæ¸…ç†ï¼‰

### æ€§èƒ½ä¼˜åŒ–
- âœ… Redis Pipeline æ‰¹é‡æ“ä½œ
- âœ… Lua è„šæœ¬å‡å°‘ RTT
- âœ… æ— é”æ•°æ®ç»“æ„ï¼ˆsync.Map å¿«é€Ÿè·¯å¾„ï¼‰

### å¯é æ€§è®¾è®¡
- âœ… TTL è‡ªåŠ¨æ¸…ç†åƒµå°¸çŠ¶æ€
- âœ… CAS é˜²æ­¢çŠ¶æ€è¦†ç›–
- âœ… å¿ƒè·³æ£€æµ‹è¿æ¥å¥åº·

### ä»£ç è´¨é‡
- âœ… defer ç¡®ä¿èµ„æºæ¸…ç†
- âœ… Context æ§åˆ¶ç”Ÿå‘½å‘¨æœŸ
- âœ… é”™è¯¯åŒ…è£…æä¾›ä¸Šä¸‹æ–‡

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### åŸºå‡†æµ‹è¯•æ•°æ® (å• Gateway)

| æŒ‡æ ‡ | æ•°å€¼ | è¯´æ˜ |
|------|------|------|
| å¹¶å‘è¿æ¥æ•° | 10,000+ | åŸºäº goroutine-per-connection |
| æ¶ˆæ¯å»¶è¿Ÿ (æœ¬åœ°) | < 1ms | å†…å­˜æŸ¥æ‰¾ + WebSocket å‘é€ |
| æ¶ˆæ¯å»¶è¿Ÿ (è·¨ç½‘å…³) | 2-5ms | Redis Pub/Sub RTT |
| å¿ƒè·³å¼€é”€ | ~0.1% CPU | æ¯ 30s ä¸€æ¬¡ï¼ŒPipeline ä¼˜åŒ– |
| å†…å­˜å ç”¨ | ~100MB | 10,000 è¿æ¥ + çŠ¶æ€ |

### æ‰©å±•æ€§

- **æ°´å¹³æ‰©å±•**: æ— ä¸Šé™ï¼ˆæ·»åŠ  Gateway èŠ‚ç‚¹ï¼‰
- **å•ç‚¹æ•…éšœ**: æ— ï¼ˆGateway æ— çŠ¶æ€ï¼‰
- **Redis ä¾èµ–**: é«˜å¯ç”¨éƒ¨ç½²ï¼ˆSentinel/Clusterï¼‰

---

## ğŸš€ å¿«é€Ÿä¸Šæ‰‹

### é˜…è¯»é¡ºåºå»ºè®®

#### æ–°æ‰‹è·¯å¾„ (ç†è§£æ¶æ„)
1. å…ˆè¯» [README.md](../README.md) äº†è§£æ•´ä½“
2. å†è¯» [Server å®ç°è¯¦è§£](./05-serverå®ç°è¯¦è§£.md) çœ‹ç»„ä»¶åè°ƒ
3. ç„¶åè¯» [Handler å®ç°è¯¦è§£](./02-handlerå®ç°è¯¦è§£.md) ç†è§£ä¸šåŠ¡æµç¨‹
4. æœ€åè¯»å…¶ä»–ç»„ä»¶çš„è¯¦è§£

#### è¿›é˜¶è·¯å¾„ (æ·±å…¥ç»†èŠ‚)
1. [Presence å®ç°è¯¦è§£](./03-presenceå®ç°è¯¦è§£.md) - CAS å’Œ Lua è„šæœ¬
2. [Router å®ç°è¯¦è§£](./01-routerå®ç°è¯¦è§£.md) - Pub/Sub æœºåˆ¶
3. [Connection å®ç°è¯¦è§£](./04-connectionå®ç°è¯¦è§£.md) - sync.Map ä¼˜åŒ–
4. [æ•…éšœæ¢å¤æµ‹è¯•](../FAILOVER_TEST_RESULTS.md) - å®æˆ˜éªŒè¯

#### é—®é¢˜é©±åŠ¨è·¯å¾„
- **æ¶ˆæ¯æ€ä¹ˆè·¯ç”±ï¼Ÿ** â†’ Router + Presence
- **è¿æ¥æ€ä¹ˆç®¡ç†ï¼Ÿ** â†’ Connection + Handler
- **çŠ¶æ€æ€ä¹ˆåŒæ­¥ï¼Ÿ** â†’ Presence + Redis
- **æ•…éšœæ€ä¹ˆæ¢å¤ï¼Ÿ** â†’ æ•…éšœæµ‹è¯•æ–‡æ¡£

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

å¦‚æœä½ åœ¨é˜…è¯»æ–‡æ¡£æ—¶å‘ç°ï¼š
- ğŸ› é”™è¯¯æˆ–ä¸å‡†ç¡®çš„æè¿°
- ğŸ“ å¯ä»¥æ”¹è¿›çš„è§£é‡Š
- ğŸ’¡ æœ‰ä»·å€¼çš„è¡¥å……å†…å®¹

æ¬¢è¿é€šè¿‡ Issue æˆ– PR è´¡çŒ®ï¼

---

## ğŸ“ è”ç³»æ–¹å¼

- **é¡¹ç›®åœ°å€**: [websocket-demo](https://github.com/your-repo/websocket-demo)
- **æ–‡æ¡£æ›´æ–°**: 2026-01-01
- **Go ç‰ˆæœ¬**: 1.21+

---

**Happy Learning! ğŸ‰**
