# Handler å®ç°è¯¦è§£

> æ–‡ä»¶ï¼š`internal/gateway/handler.go`
> ä½œç”¨ï¼šWebSocket è¿æ¥å¤„ç†å’Œä¸šåŠ¡é€»è¾‘å±‚

## ç›®å½•

- [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
- [æ ¸å¿ƒå¸¸é‡å®šä¹‰](#æ ¸å¿ƒå¸¸é‡å®šä¹‰)
- [æ¶ˆæ¯åè®®è®¾è®¡](#æ¶ˆæ¯åè®®è®¾è®¡)
- [æ ¸å¿ƒæµç¨‹è¯¦è§£](#æ ¸å¿ƒæµç¨‹è¯¦è§£)
- [æ³¨å†Œæµç¨‹](#æ³¨å†Œæµç¨‹è¯¦è§£)
- [å¿ƒè·³æœºåˆ¶](#å¿ƒè·³æœºåˆ¶è¯¦è§£)
- [æ¶ˆæ¯è·¯ç”±](#æ¶ˆæ¯è·¯ç”±è¯¦è§£)
- [è¿æ¥æ¸…ç†](#è¿æ¥æ¸…ç†æµç¨‹)
- [å¹¶å‘å®‰å…¨åˆ†æ](#å¹¶å‘å®‰å…¨åˆ†æ)
- [é”™è¯¯å¤„ç†ç­–ç•¥](#é”™è¯¯å¤„ç†ç­–ç•¥)

---

## æ•´ä½“æ¶æ„

### handler.go åœ¨ç³»ç»Ÿä¸­çš„ä½ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Client                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ WebSocket
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              handler.go                         â”‚
â”‚  â€¢ è¿æ¥ç®¡ç†ï¼ˆæ³¨å†Œ/æ–­å¼€ï¼‰                          â”‚
â”‚  â€¢ æ¶ˆæ¯è·¯ç”±ï¼ˆæœ¬åœ°/è·¨ç½‘å…³ï¼‰                        â”‚
â”‚  â€¢ å¿ƒè·³æ£€æµ‹                                      â”‚
â”‚  â€¢ é”™è¯¯å¤„ç†                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚              â”‚
       â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ connection.goâ”‚  â”‚  router.go   â”‚
â”‚ (æœ¬åœ°çŠ¶æ€)    â”‚  â”‚ (è·¨ç½‘å…³é€šä¿¡)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                 â”‚
       â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚presence.go   â”‚  â”‚  Redis       â”‚
â”‚(å…¨å±€çŠ¶æ€)    â”‚  â”‚  Pub/Sub     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒå¸¸é‡å®šä¹‰

### å¿ƒè·³ä¸æ¶ˆæ¯ç±»å‹å¸¸é‡ (handler.go:14-25)

```go
const (
    // Heartbeat settings
    heartbeatInterval = 30 * time.Second   // å®¢æˆ·ç«¯å¿ƒè·³é—´éš”
    heartbeatTimeout  = 90 * time.Second   // è¶…æ—¶é˜ˆå€¼ï¼ˆ3å€å¿ƒè·³ï¼‰

    // Message types
    msgTypePing     = "ping"
    msgTypePong     = "pong"
    msgTypeMessage  = "message"
    msgTypeRegister = "register"
    msgTypeError    = "error"
)
```

### ä¸ºä»€ä¹ˆå¿ƒè·³è¶…æ—¶æ˜¯ 3 å€é—´éš”ï¼Ÿ

```
æ­£å¸¸æƒ…å†µï¼š
  T0: Client å‘é€ ping
  T30: Client å‘é€ ping
  T60: Client å‘é€ ping
  T90: Client å‘é€ ping  â† Gateway æœ€å¤šç­‰åˆ°è¿™é‡Œ

å¼‚å¸¸æƒ…å†µï¼ˆç½‘ç»œæŠ–åŠ¨ï¼‰ï¼š
  T0: Client å‘é€ pingï¼ˆæˆåŠŸï¼‰
  T30: Client å‘é€ pingï¼ˆä¸¢åŒ…ï¼‰â† å…è®¸ä¸¢å¤± 1 æ¬¡
  T60: Client å‘é€ pingï¼ˆä¸¢åŒ…ï¼‰â† å…è®¸ä¸¢å¤± 2 æ¬¡
  T90: ä»æœªæ”¶åˆ° â†’ åˆ¤å®šè¶…æ—¶    â† å®¹å¿åº¦ = 2 æ¬¡ä¸¢åŒ…
```

**3 å€æ˜¯ä¸šç•Œæ ‡å‡†**ï¼Œå¹³è¡¡äº†å®¹é”™æ€§å’ŒåŠæ—¶æ€§ï¼š
- 2 å€ï¼šå¤ªæ¿€è¿›ï¼Œç½‘ç»œæŠ–åŠ¨å®¹æ˜“è¯¯æ€
- 4 å€ï¼šå¤ªä¿å®ˆï¼Œåƒµå°¸è¿æ¥å ç”¨èµ„æº

---

## æ¶ˆæ¯åè®®è®¾è®¡

### ClientMessage - å®¢æˆ·ç«¯å‘é€ (handler.go:28-33)

```go
type ClientMessage struct {
    Type    string `json:"type"`           // æ¶ˆæ¯ç±»å‹
    To      string `json:"to,omitempty"`   // æ¥æ”¶è€…ï¼ˆä»… message ç±»å‹ï¼‰
    Content string `json:"content,omitempty"` // æ¶ˆæ¯å†…å®¹
    UserID  string `json:"userId,omitempty"`  // ç”¨æˆ· IDï¼ˆä»… register ç±»å‹ï¼‰
}
```

**å®é™…æ¶ˆæ¯ç¤ºä¾‹ï¼š**

```json
// æ³¨å†Œ
{"type": "register", "userId": "alice"}

// å¿ƒè·³
{"type": "ping"}

// å‘é€æ¶ˆæ¯
{"type": "message", "to": "bob", "content": "Hello!"}
```

### ServerMessage - æœåŠ¡å™¨å‘é€ (handler.go:36-41)

```go
type ServerMessage struct {
    Type    string `json:"type"`
    From    string `json:"from,omitempty"`    // å‘é€è€…
    Content string `json:"content,omitempty"` // æ¶ˆæ¯å†…å®¹
    Error   string `json:"error,omitempty"`   // é”™è¯¯ä¿¡æ¯
}
```

**å®é™…å“åº”ç¤ºä¾‹ï¼š**

```json
// æ³¨å†ŒæˆåŠŸ
{"type": "registered", "content": "Successfully registered"}

// å¿ƒè·³å“åº”
{"type": "pong"}

// æ”¶åˆ°æ¶ˆæ¯
{"type": "message", "from": "alice", "content": "Hello!"}

// é”™è¯¯
{"type": "error", "error": "User not found"}
```

---

## æ ¸å¿ƒæµç¨‹ï¼šhandleConnection()

è¿™æ˜¯**æ•´ä¸ª handler.go çš„ä¸»å…¥å£**ï¼Œå¤„ç†å•ä¸ª WebSocket è¿æ¥çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸã€‚

### æµç¨‹å›¾

```
WebSocket è¿æ¥å»ºç«‹
    â†“
handleConnection() å¯åŠ¨
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ— é™å¾ªç¯è¯»å–æ¶ˆæ¯        â”‚
â”‚  conn.ReadMessage()     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”œâ”€â†’ register â†’ æ³¨å†Œç”¨æˆ· â†’ å¯åŠ¨å¿ƒè·³æ£€æµ‹
          â”œâ”€â†’ ping     â†’ æ›´æ–°å¿ƒè·³ â†’ åˆ·æ–° Redis TTL
          â”œâ”€â†’ message  â†’ è·¯ç”±æ¶ˆæ¯ â†’ routeMessage()
          â””â”€â†’ å…¶ä»–     â†’ å‘é€é”™è¯¯
          â”‚
    è¿æ¥æ–­å¼€/é”™è¯¯
          â†“
    æ¸…ç†èµ„æºï¼ˆç§»é™¤è¿æ¥ã€åˆ é™¤ Presenceï¼‰
          â†“
handleConnection() ç»“æŸ
```

### åˆå§‹åŒ–é˜¶æ®µ (handler.go:44-51)

```go
func (s *Server) handleConnection(conn *websocket.Conn, connID string) {
    defer conn.Close()  // â† ç¡®ä¿è¿æ¥æ€»ä¼šå…³é—­

    var userID string       // ç”¨æˆ· IDï¼ˆåˆå§‹ä¸ºç©ºï¼Œæ³¨å†Œåèµ‹å€¼ï¼‰
    var wsConn *Connection  // Connection å¯¹è±¡ï¼ˆæ³¨å†Œååˆ›å»ºï¼‰

    ctx, cancel := context.WithCancel(context.Background())
    defer cancel()  // â† ç¡®ä¿ context æ€»ä¼šå–æ¶ˆ
```

**å…³é”®è®¾è®¡ï¼š**

| å˜é‡ | åˆå§‹å€¼ | èµ‹å€¼æ—¶æœº | ä½œç”¨ |
|------|--------|---------|------|
| `userID` | `""` | æ”¶åˆ° register æ¶ˆæ¯ | æ ‡è¯†ç”¨æˆ·èº«ä»½ |
| `wsConn` | `nil` | æ³¨å†ŒæˆåŠŸå | ç®¡ç†è¿æ¥çŠ¶æ€ |
| `ctx` | æ–° Context | å‡½æ•°å¼€å§‹ | æ§åˆ¶å¿ƒè·³æ£€æµ‹ goroutine |

**ä¸ºä»€ä¹ˆ userID åˆå§‹ä¸ºç©ºï¼Ÿ**

```
æœªæ³¨å†Œç”¨æˆ·åªèƒ½åšä¸¤ä»¶äº‹ï¼š
  1. å‘é€ register æ¶ˆæ¯
  2. æ–­å¼€è¿æ¥

å…¶ä»–æ¶ˆæ¯ï¼ˆping/messageï¼‰éƒ½éœ€è¦å…ˆæ³¨å†Œ
```

### æ¶ˆæ¯è¯»å–å¾ªç¯ (handler.go:54-68)

```go
for {
    _, message, err := conn.ReadMessage()  // â† é˜»å¡è¯»å–
    if err != nil {
        if websocket.IsUnexpectedCloseError(err,
            websocket.CloseGoingAway,
            websocket.CloseAbnormalClosure) {
            log.Printf("[Handler] WebSocket error: %v", err)
        }
        break  // â† ä»»ä½•é”™è¯¯éƒ½é€€å‡ºå¾ªç¯
    }

    var msg ClientMessage
    if err := json.Unmarshal(message, &msg); err != nil {
        log.Printf("[Handler] Failed to unmarshal message: %v", err)
        s.sendError(conn, "Invalid message format")
        continue  // â† JSON é”™è¯¯ç»§ç»­å¾ªç¯ï¼Œè¿æ¥ä¸æ–­å¼€
    }
```

**ä¸ºä»€ä¹ˆåŒºåˆ† break å’Œ continueï¼Ÿ**

```
ReadMessage é”™è¯¯ â†’ break
  â€¢ è¿æ¥å·²æ–­å¼€ï¼Œæ— æ³•æ¢å¤
  â€¢ é€€å‡ºå¾ªç¯ï¼Œæ‰§è¡Œæ¸…ç†é€»è¾‘

JSON è§£æé”™è¯¯ â†’ continue
  â€¢ åªæ˜¯æ¶ˆæ¯æ ¼å¼é”™è¯¯ï¼Œè¿æ¥ä»æœ‰æ•ˆ
  â€¢ å‘é€é”™è¯¯æ¶ˆæ¯ï¼Œç­‰å¾…ä¸‹ä¸€æ¡æ¶ˆæ¯
```

**IsUnexpectedCloseError çš„ä½œç”¨ï¼Ÿ**

```go
websocket.IsUnexpectedCloseError(err,
    websocket.CloseGoingAway,        // 1001: æµè§ˆå™¨æ ‡ç­¾å…³é—­
    websocket.CloseAbnormalClosure)  // 1006: ç½‘ç»œå¼‚å¸¸
```

è¿‡æ»¤æ‰**æ­£å¸¸å…³é—­**ï¼ˆ1000ï¼‰ï¼Œåªè®°å½•**å¼‚å¸¸å…³é—­**çš„æ—¥å¿—ã€‚

---

## æ³¨å†Œæµç¨‹è¯¦è§£

### å®Œæ•´æµç¨‹

```
Step 1: å®¢æˆ·ç«¯å‘é€ {"type": "register", "userId": "alice"}
    â†“
Step 2: éªŒè¯ userID éç©º
    â†“
Step 3: åˆ›å»º Connection å¯¹è±¡
    wsConn = NewConnection(connID, userID, conn)
    â†“
Step 4: æ·»åŠ åˆ°æœ¬åœ°è¿æ¥ç®¡ç†å™¨
    s.connMgr.Add(wsConn)
    â†“
Step 5: æ³¨å†Œåˆ° Redis Presenceï¼ˆå¸¦ CASï¼‰
    s.presenceMgr.Register(ctx, userID, gatewayID, connID)
    â†“
Step 6: å‘é€æ³¨å†ŒæˆåŠŸå“åº”
    {"type": "registered", "content": "Successfully registered"}
    â†“
Step 7: å¯åŠ¨å¿ƒè·³æ£€æµ‹ goroutine
    go s.heartbeatChecker(ctx, wsConn)
```

### ä»£ç è¯¦è§£ (handler.go:71-100)

```go
case msgTypeRegister:
    // â† éªŒè¯ç”¨æˆ· ID
    if msg.UserID == "" {
        s.sendError(conn, "UserID is required for registration")
        continue
    }

    userID = msg.UserID  // â† ä¿å­˜åˆ°å¤–å±‚ä½œç”¨åŸŸ
    wsConn = NewConnection(connID, userID, conn)

    // â† Step 1: æœ¬åœ°çŠ¶æ€
    s.connMgr.Add(wsConn)

    // â† Step 2: å…¨å±€çŠ¶æ€ï¼ˆRedisï¼‰
    if err := s.presenceMgr.Register(ctx, userID, s.gatewayID, connID); err != nil {
        log.Printf("[Handler] Failed to register presence: %v", err)
        s.sendError(conn, "Failed to register")
        continue  // â† Redis å¤±è´¥ä¸æ–­å¼€è¿æ¥ï¼Œå…è®¸é‡è¯•
    }

    log.Printf("[Handler] User %s registered on gateway %s (connID: %s)",
               userID, s.gatewayID, connID)

    // â† å‘é€æˆåŠŸå“åº”
    s.sendMessage(conn, ServerMessage{
        Type:    "registered",
        Content: "Successfully registered",
    })

    // â† å¯åŠ¨å¿ƒè·³æ£€æµ‹ï¼ˆå¼‚æ­¥ï¼‰
    go s.heartbeatChecker(ctx, wsConn)
```

### å…³é”®è®¾è®¡å†³ç­–

#### ä¸ºä»€ä¹ˆå…ˆæ›´æ–°æœ¬åœ°ï¼Œå†æ›´æ–° Redisï¼Ÿ

```
é¡ºåº Aï¼ˆå½“å‰å®ç°ï¼‰ï¼š
  connMgr.Add() â†’ presenceMgr.Register()

ä¼˜ç‚¹ï¼š
  âœ… Redis å¤±è´¥æ—¶ï¼Œæœ¬åœ°å·²æœ‰è¿æ¥ï¼Œå¯ä»¥é‡è¯•æ³¨å†Œ
  âœ… å¿ƒè·³æ£€æµ‹ç«‹å³å¯ç”¨

é¡ºåº Bï¼ˆåè¿‡æ¥ï¼‰ï¼š
  presenceMgr.Register() â†’ connMgr.Add()

ç¼ºç‚¹ï¼š
  âŒ Redis æˆåŠŸä½† connMgr.Add() å¤±è´¥ â†’ Redis æœ‰è„æ•°æ®
  âŒ å…¶ä»– Gateway ä¼šè·¯ç”±æ¶ˆæ¯è¿‡æ¥ï¼Œä½†æœ¬åœ°æ‰¾ä¸åˆ°è¿æ¥
```

#### Redis æ³¨å†Œå¤±è´¥ä¸ºä»€ä¹ˆç”¨ continue è€Œä¸æ˜¯ breakï¼Ÿ

```go
if err := s.presenceMgr.Register(...); err != nil {
    s.sendError(conn, "Failed to register")
    continue  // â† ä¸æ˜¯ break
}
```

**åŸå› ï¼š** Redis å¯èƒ½æ˜¯**ä¸´æ—¶æ•…éšœ**ï¼ˆç½‘ç»œæŠ–åŠ¨ï¼‰ï¼Œå®¢æˆ·ç«¯å¯ä»¥é‡è¯•ï¼š

```
Client è¡Œä¸ºï¼š
  T0: å‘é€ register â†’ æ”¶åˆ° error
  T1: é‡è¯• register â†’ æˆåŠŸ
```

å¦‚æœç”¨ `break`ï¼Œè¿æ¥ç›´æ¥æ–­å¼€ï¼Œä½“éªŒå¾ˆå·®ã€‚

---

## å¿ƒè·³æœºåˆ¶è¯¦è§£

### ä¸¤ä¸ªç»„æˆéƒ¨åˆ†

#### 1. å®¢æˆ·ç«¯å‘é€ ping (handler.go:102-114)

```go
case msgTypePing:
    // â† æ›´æ–°æœ¬åœ°è¿æ¥çš„æœ€åå¿ƒè·³æ—¶é—´
    if wsConn != nil {
        wsConn.UpdatePing()

        // â† åˆ·æ–° Redis Presence TTLï¼ˆ90sï¼‰
        if err := s.presenceMgr.Refresh(ctx, userID); err != nil {
            log.Printf("[Handler] Failed to refresh presence: %v", err)
        }
    }

    // â† ç«‹å³å“åº” pong
    s.sendMessage(conn, ServerMessage{Type: msgTypePong})
```

**ä¸ºä»€ä¹ˆè¦åŒæ—¶æ›´æ–°æœ¬åœ°å’Œ Redisï¼Ÿ**

```
æœ¬åœ° lastPing:
  â€¢ ç”¨äº heartbeatChecker() æ£€æµ‹è¶…æ—¶
  â€¢ å¿«é€Ÿï¼ˆå†…å­˜æ“ä½œï¼‰

Redis TTL:
  â€¢ ç”¨äºå…¶ä»– Gateway æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦åœ¨çº¿
  â€¢ é˜²æ­¢ Gateway å®•æœºå Presence æ°¸ä¹…æ®‹ç•™
```

#### 2. æœåŠ¡ç«¯æ£€æµ‹è¶…æ—¶ (handler.go:212-229)

```go
func (s *Server) heartbeatChecker(ctx context.Context, conn *Connection) {
    ticker := time.NewTicker(heartbeatInterval)  // 30s
    defer ticker.Stop()

    for {
        select {
        case <-ticker.C:  // â† æ¯ 30s æ£€æŸ¥ä¸€æ¬¡
            if time.Since(conn.GetLastPing()) > heartbeatTimeout {  // 90s
                log.Printf("[Handler] Connection timeout for user %s", conn.UserID)
                conn.Close()  // â† å¼ºåˆ¶å…³é—­è¿æ¥
                return
            }

        case <-ctx.Done():  // â† ç”¨æˆ·æ­£å¸¸æ–­å¼€
            return
        }
    }
}
```

### æ—¶åºå›¾

```
æ—¶é—´è½´ï¼š
T0  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Client è¿æ¥ï¼Œæ³¨å†ŒæˆåŠŸ
    go heartbeatChecker() å¯åŠ¨

T30 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Client å‘é€ ping â†’ Server æ›´æ–° lastPing

    heartbeatChecker: time.Since(lastPing) = 0s < 90s âœ“

T60 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    Client å‘é€ ping â†’ Server æ›´æ–° lastPing

    heartbeatChecker: time.Since(lastPing) = 0s < 90s âœ“

T90 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    å‡è®¾ç½‘ç»œæ–­å¼€ï¼ŒClient æœªå‘é€ ping

    heartbeatChecker: time.Since(lastPing) = 30s < 90s âœ“

T120 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    heartbeatChecker: time.Since(lastPing) = 60s < 90s âœ“

T150 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    heartbeatChecker: time.Since(lastPing) = 90s >= 90s âœ—

    æ‰§è¡Œ conn.Close() â†’ è§¦å‘æ–­å¼€æµç¨‹
```

### ä¸ºä»€ä¹ˆæ£€æµ‹é—´éš”ç­‰äºå¿ƒè·³é—´éš”ï¼Ÿ

```go
ticker := time.NewTicker(heartbeatInterval)  // 30s
```

**å¯é€‰æ–¹æ¡ˆå¯¹æ¯”ï¼š**

| æ–¹æ¡ˆ | æ£€æµ‹é—´éš” | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|------|------|
| æ–¹æ¡ˆ Aï¼ˆå½“å‰ï¼‰ | 30s | CPU å¼€é”€ä½ | æ£€æµ‹å»¶è¿Ÿ Â±30s |
| æ–¹æ¡ˆ B | 10s | æ›´å¿«å‘ç°è¶…æ—¶ | CPU å¼€é”€é«˜ 3 å€ |
| æ–¹æ¡ˆ C | 60s | CPU å¼€é”€æ›´ä½ | è¶…æ—¶å‘ç°å¤ªæ…¢ |

**å½“å‰å®ç°æ˜¯åˆç†æŠ˜ä¸­**ï¼š
- è¿æ¥è¶…æ—¶åæœ€å¤š 30s æ‰è¢«æ¸…ç†
- å¯¹äº IM ç³»ç»Ÿï¼Œ30s å»¶è¿Ÿå¯æ¥å—

---

## æ¶ˆæ¯è·¯ç”±è¯¦è§£

### å‘é€æ¶ˆæ¯æµç¨‹ (handler.go:116-134)

```go
case msgTypeMessage:
    // â† éªŒè¯ï¼šå¿…é¡»å…ˆæ³¨å†Œ
    if userID == "" {
        s.sendError(conn, "Not registered")
        continue
    }

    // â† éªŒè¯ï¼šå¿…é¡»æŒ‡å®šæ¥æ”¶è€…
    if msg.To == "" {
        s.sendError(conn, "Recipient is required")
        continue
    }

    // â† è·¯ç”±æ¶ˆæ¯
    if err := s.routeMessage(ctx, userID, msg.To, msg.Content); err != nil {
        log.Printf("[Handler] Failed to route message: %v", err)
        s.sendError(conn, "Failed to send message")
        continue
    }

    log.Printf("[Handler] Message routed: %s -> %s", userID, msg.To)
```

### routeMessage() - æŸ¥è¯¢è·¯ç”±å¹¶å‘é€ (handler.go:154-170)

```go
func (s *Server) routeMessage(ctx context.Context, from, to, content string) error {
    // â† Step 1: æŸ¥è¯¢æ¥æ”¶è€…åœ¨å“ªä¸ª Gateway
    presence, err := s.presenceMgr.Get(ctx, to)
    if err != nil {
        return err  // ç”¨æˆ·ç¦»çº¿æˆ–æŸ¥è¯¢å¤±è´¥
    }

    // â† Step 2: æ„é€ è·¯ç”±æ¶ˆæ¯
    msg := &router.Message{
        From:    from,
        To:      to,
        Content: content,
        Type:    "direct",
    }

    // â† Step 3: å‘é€åˆ°ç›®æ ‡ Gateway
    return s.router.RouteToGateway(ctx, presence.GatewayID, msg)
}
```

### å®Œæ•´æ¶ˆæ¯æµï¼ˆè·¨ç½‘å…³ï¼‰

```
Alice@Gateway-01 å‘é€æ¶ˆæ¯ç»™ Bob@Gateway-02

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Client å‘é€ WebSocket æ¶ˆæ¯                          â”‚
â”‚   {"type": "message", "to": "bob", "content": "Hello"}    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: handleConnection() æ”¶åˆ°æ¶ˆæ¯                         â”‚
â”‚   switch msg.Type â†’ case msgTypeMessage                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: routeMessage() æŸ¥è¯¢ Bob çš„ä½ç½®                      â”‚
â”‚   presenceMgr.Get("bob") â†’ {gwId: "gateway-02"}           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: å‘é€åˆ°ç›®æ ‡ Gateway                                  â”‚
â”‚   router.RouteToGateway("gateway-02", msg)                 â”‚
â”‚   â†’ Redis PUBLISH gateway:gateway-02 {...}                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             Redis Pub/Sub
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: Gateway-02 çš„ router.processMessages() æ”¶åˆ°æ¶ˆæ¯     â”‚
â”‚   è°ƒç”¨ handler: deliverMessage(msg)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: deliverMessage() æŸ¥æ‰¾æœ¬åœ°è¿æ¥                       â”‚
â”‚   connMgr.GetByUserID("bob") â†’ conn                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 7: é€šè¿‡ WebSocket å‘é€ç»™ Bob                           â”‚
â”‚   conn.WriteMessage({"type":"message","from":"alice",...}) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æœ¬åœ°æ¶ˆæ¯æŠ•é€’ï¼šdeliverMessage()

è¿™æ˜¯ Router çš„å›è°ƒå‡½æ•°ï¼Œå¤„ç†**ä» Redis æ”¶åˆ°çš„æ¶ˆæ¯**ã€‚

```go
func (s *Server) deliverMessage(msg *router.Message) {
    // â† åœ¨æœ¬åœ°è¿æ¥ç®¡ç†å™¨ä¸­æŸ¥æ‰¾æ¥æ”¶è€…
    conn, ok := s.connMgr.GetByUserID(msg.To)
    if !ok {
        log.Printf("[Handler] User %s not found locally", msg.To)
        return  // â† æ­£å¸¸æƒ…å†µï¼šç”¨æˆ·åˆšå¥½æ–­å¼€è¿æ¥
    }

    // â† è½¬æ¢æ¶ˆæ¯æ ¼å¼ï¼ˆrouter.Message â†’ ServerMessageï¼‰
    serverMsg := ServerMessage{
        Type:    msgTypeMessage,
        From:    msg.From,
        Content: msg.Content,
    }

    // â† å‘é€ç»™å®¢æˆ·ç«¯
    s.sendMessage(conn.Conn, serverMsg)
    log.Printf("[Handler] Message delivered to %s", msg.To)
}
```

### ä¸ºä»€ä¹ˆå¯èƒ½æ‰¾ä¸åˆ°ç”¨æˆ·ï¼Ÿ

```
æ—¶åºé—®é¢˜ï¼š
  T0: Bob åœ¨çº¿ï¼ŒAlice æŸ¥è¯¢ Presence â†’ gateway-02
  T1: Alice å‘é€æ¶ˆæ¯åˆ° gateway-02
  T2: Bob æ–­å¼€è¿æ¥ï¼ˆRedis Pub/Sub æœ‰å»¶è¿Ÿï¼‰
  T3: Gateway-02 æ”¶åˆ°æ¶ˆæ¯ï¼Œä½† Bob å·²ä¸åœ¨æœ¬åœ°
      â†’ æ‰“å°æ—¥å¿—ï¼Œä¸¢å¼ƒæ¶ˆæ¯
```

**è¿™æ˜¯å¯æ¥å—çš„**ï¼š
- WebSocket æœ¬èº«ä¸ä¿è¯æ¶ˆæ¯å¯é é€è¾¾
- ç”Ÿäº§ç¯å¢ƒä¼šæœ‰ç¦»çº¿æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå­˜åˆ° DB/Kafkaï¼‰

---

## è¿æ¥æ¸…ç†æµç¨‹

å½“ `ReadMessage()` è¿”å›é”™è¯¯æ—¶ï¼Œé€€å‡ºæ¶ˆæ¯å¾ªç¯ï¼Œæ‰§è¡Œæ¸…ç†ï¼š

```go
// Cleanup on disconnect
if wsConn != nil {  // â† åªæœ‰æ³¨å†Œè¿‡çš„ç”¨æˆ·æ‰éœ€è¦æ¸…ç†
    // â† Step 1: ç§»é™¤æœ¬åœ°è¿æ¥
    s.connMgr.Remove(wsConn)

    // â† Step 2: åˆ é™¤ Redis Presence
    if err := s.presenceMgr.Remove(ctx, userID); err != nil {
        log.Printf("[Handler] Failed to remove presence: %v", err)
    }

    log.Printf("[Handler] User %s disconnected (connID: %s)", userID, connID)
}
```

### ä¸ºä»€ä¹ˆå…ˆç§»é™¤æœ¬åœ°ï¼Œå†åˆ é™¤ Redisï¼Ÿ

```
é¡ºåº Aï¼ˆå½“å‰å®ç°ï¼‰ï¼š
  connMgr.Remove() â†’ presenceMgr.Remove()

ä¼˜ç‚¹ï¼š
  âœ… ç«‹å³åœæ­¢æ¥æ”¶æ–°æ¶ˆæ¯ï¼ˆå…¶ä»– Gateway è¿˜èƒ½è·¯ç”±è¿‡æ¥ï¼‰
  âœ… Redis åˆ é™¤å¤±è´¥å½±å“å°ï¼ˆTTL ä¼šè‡ªåŠ¨è¿‡æœŸï¼‰

é¡ºåº Bï¼ˆåè¿‡æ¥ï¼‰ï¼š
  presenceMgr.Remove() â†’ connMgr.Remove()

ç¼ºç‚¹ï¼š
  âŒ Redis åˆ é™¤åï¼Œæœ¬åœ°è¿æ¥è¿˜åœ¨ â†’ çŸ­æš‚ä¸ä¸€è‡´
  âŒ å…¶ä»– Gateway è®¤ä¸ºç”¨æˆ·ç¦»çº¿ï¼Œä½†æœ¬åœ°è¿˜èƒ½æ”¶æ¶ˆæ¯
```

### æ¸…ç†æ—¶åºå›¾

```
ç”¨æˆ·æ–­å¼€è¿æ¥çš„å®Œæ•´æµç¨‹ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. è¿æ¥æ–­å¼€ï¼ˆç½‘ç»œ/æµè§ˆå™¨å…³é—­ï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ReadMessage() è¿”å›é”™è¯¯                               â”‚
â”‚     websocket.IsUnexpectedCloseError() è®°å½•æ—¥å¿—          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. break é€€å‡ºæ¶ˆæ¯å¾ªç¯                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. æ‰§è¡Œæ¸…ç†ä»£ç                                          â”‚
â”‚     if wsConn != nil {                                  â”‚
â”‚         connMgr.Remove(wsConn)                          â”‚
â”‚         presenceMgr.Remove(ctx, userID)                 â”‚
â”‚     }                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. defer è¯­å¥æ‰§è¡Œ                                       â”‚
â”‚     cancel() â†’ é€šçŸ¥ heartbeatChecker é€€å‡º                â”‚
â”‚     conn.Close() â†’ ç¡®ä¿è¿æ¥å…³é—­                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å¹¶å‘å®‰å…¨åˆ†æ

### 1. handleConnection çš„ç”Ÿå‘½å‘¨æœŸ

```go
æ¯ä¸ª WebSocket è¿æ¥ â†’ ä¸€ä¸ªç‹¬ç«‹çš„ goroutine è¿è¡Œ handleConnection
```

**ä¸ä¼šå¹¶å‘è®¿é—®çš„å˜é‡ï¼š**
- `userID`, `wsConn` - åªåœ¨å½“å‰ goroutine è¯»å†™
- `ctx` - åªä¼ é€’ç»™å­ goroutineï¼Œä¸ä¿®æ”¹

**éœ€è¦å¹¶å‘ä¿æŠ¤çš„å…±äº«èµ„æºï¼š**
- `s.connMgr` - ä½¿ç”¨ `sync.Map`ï¼Œçº¿ç¨‹å®‰å…¨
- `s.presenceMgr` - åº•å±‚æ˜¯ Redisï¼ŒåŸå­æ“ä½œ
- `s.router` - å‘å¸ƒåˆ° Redisï¼Œæ— å…±äº«çŠ¶æ€

### 2. heartbeatChecker çš„å¹¶å‘

```go
// handleConnection ä¸­å¯åŠ¨
go s.heartbeatChecker(ctx, wsConn)
```

**æ½œåœ¨ç«æ€æ¡ä»¶ï¼š**

```
Goroutine A (handleConnection):        Goroutine B (heartbeatChecker):
ReadMessage() è¿”å›é”™è¯¯
break é€€å‡ºå¾ªç¯
æ‰§è¡Œ connMgr.Remove(wsConn)
                                       ticker.C è§¦å‘
                                       conn.GetLastPing() â†’ è¶…æ—¶
                                       conn.Close() â† å¯èƒ½åœ¨è¿™é‡Œ
defer conn.Close()  â† ä¹Ÿåœ¨è¿™é‡Œå…³é—­
```

**è§£å†³æ–¹æ¡ˆï¼š**
`websocket.Conn.Close()` æ˜¯**å¹‚ç­‰**çš„ï¼Œå¤šæ¬¡è°ƒç”¨ä¸ä¼š panicã€‚

### 3. Context å–æ¶ˆä¼ æ’­

```go
ctx, cancel := context.WithCancel(...)
defer cancel()  // â† handleConnection é€€å‡ºæ—¶å–æ¶ˆ

go s.heartbeatChecker(ctx, wsConn)
```

**å–æ¶ˆæµç¨‹ï¼š**

```
handleConnection é€€å‡º
    â†“
defer cancel() æ‰§è¡Œ
    â†“
ctx.Done() channel è¢«å…³é—­
    â†“
heartbeatChecker ä¸­çš„ select æ”¶åˆ°ä¿¡å·
    â†“
case <-ctx.Done(): return
    â†“
heartbeatChecker goroutine é€€å‡º
```

è¿™ç¡®ä¿äº†**æ—  goroutine æ³„æ¼**ã€‚

---

## é”™è¯¯å¤„ç†ç­–ç•¥

### é”™è¯¯åˆ†ç±»ä¸å¤„ç†

| é”™è¯¯ç±»å‹ | ç¤ºä¾‹ | å¤„ç†æ–¹å¼ | åŸå›  |
|---------|------|---------|------|
| **è‡´å‘½é”™è¯¯** | `ReadMessage()` å¤±è´¥ | `break` é€€å‡ºå¾ªç¯ | è¿æ¥å·²ä¸å¯ç”¨ |
| **å¯æ¢å¤é”™è¯¯** | JSON è§£æå¤±è´¥ | `sendError()` + `continue` | å•æ¡æ¶ˆæ¯é—®é¢˜ |
| **ä¸šåŠ¡é”™è¯¯** | ç”¨æˆ·ç¦»çº¿ | è¿”å› error ç»™è°ƒç”¨è€… | æ­£å¸¸ä¸šåŠ¡é€»è¾‘ |
| **åŸºç¡€è®¾æ–½é”™è¯¯** | Redis è¿æ¥å¤±è´¥ | è®°å½•æ—¥å¿— + ç»§ç»­è¿è¡Œ | ä¸´æ—¶æ•…éšœï¼Œå¯èƒ½æ¢å¤ |

---

## æ€§èƒ½ä¼˜åŒ–è€ƒè™‘

### ä¸ºä»€ä¹ˆä¸ç”¨ goroutine å¤„ç†æ¯æ¡æ¶ˆæ¯ï¼Ÿ

```go
// å½“å‰å®ç°ï¼ˆåŒæ­¥ï¼‰
for {
    _, message, err := conn.ReadMessage()
    // ç›´æ¥å¤„ç†æ¶ˆæ¯
    switch msg.Type { ... }
}
```

**åŒæ­¥çš„å¥½å¤„ï¼š**
- âœ… ä¿è¯æ¶ˆæ¯**é¡ºåºå¤„ç†**
- âœ… é¿å… goroutine çˆ†ç‚¸ï¼ˆ1 ä¸‡è¿æ¥ = 1 ä¸‡ goroutineï¼Œè€Œé 10 ä¸‡+ï¼‰
- âœ… èƒŒå‹æ§åˆ¶ï¼ˆå®¢æˆ·ç«¯å‘å¤ªå¿«ä¼šè¢« TCP æµæ§é™åˆ¶ï¼‰

---

## æ€»ç»“

### handler.go çš„è®¾è®¡ç²¾é«“

1. **çŠ¶æ€æœºè®¾è®¡**
   ```
   æœªè¿æ¥ â†’ å·²è¿æ¥ â†’ å·²æ³¨å†Œ â†’ æ–­å¼€
             â†“         â†“
          æ‹’ç»æ¶ˆæ¯   å¤„ç†æ¶ˆæ¯
   ```

2. **èŒè´£åˆ†ç¦»**
   - `handleConnection`: è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†
   - `routeMessage`: æ¶ˆæ¯è·¯ç”±é€»è¾‘
   - `deliverMessage`: æœ¬åœ°æŠ•é€’
   - `heartbeatChecker`: å¥åº·æ£€æµ‹

3. **ä¼˜é›…é™çº§**
   - Redis å¤±è´¥ â†’ å…è®¸é‡è¯•ï¼Œä¸æ–­å¼€è¿æ¥
   - æ¶ˆæ¯æŠ•é€’å¤±è´¥ â†’ è®°å½•æ—¥å¿—ï¼Œä¸å½±å“å…¶ä»–ç”¨æˆ·

4. **èµ„æºæ¸…ç†**
   - `defer conn.Close()` - ç¡®ä¿è¿æ¥å…³é—­
   - `defer cancel()` - ç¡®ä¿ goroutine é€€å‡º
   - æ¸…ç†é¡ºåºï¼šæœ¬åœ° â†’ è¿œç¨‹ï¼ˆå…ˆå¿«åæ…¢ï¼‰

è¿™ä¸ª handler.go æ˜¯ä¸€ä¸ª**æ•™ç§‘ä¹¦çº§åˆ«çš„ WebSocket å¤„ç†å™¨å®ç°**ï¼Œæ¶µç›–äº†ç”Ÿäº§ç¯å¢ƒçš„æ‰€æœ‰æ ¸å¿ƒè¦ç´ ï¼ğŸ¯
